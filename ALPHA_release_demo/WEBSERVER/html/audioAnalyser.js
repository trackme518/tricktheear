!function(t,e){if("object"==typeof exports&&"object"==typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var n=e();for(var i in n)("object"==typeof exports?exports:t)[i]=n[i]}}("undefined"!=typeof self?self:this,function(){return function(t){function e(i){if(n[i])return n[i].exports;var o=n[i]={i:i,l:!1,exports:{}};return t[i].call(o.exports,o,o.exports,e),o.l=!0,o.exports}var n={};return e.m=t,e.c=n,e.d=function(t,n,i){e.o(t,n)||Object.defineProperty(t,n,{configurable:!1,enumerable:!0,get:i})},e.n=function(t){var n=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(n,"a",n),n},e.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},e.p="",e(e.s=0)}([function(t,e,n){"use strict";if("undefined"==typeof AFRAME)throw new Error("Component attempted to register before AFRAME was available.");var i={};AFRAME.registerComponent("audioanalyser",{schema:{buffer:{default:!1},beatDetectionDecay:{default:.99},beatDetectionMinVolume:{default:15},beatDetectionThrottle:{default:250},enabled:{default:!0},enableBeatDetection:{default:!0},enableLevels:{default:!0},enableWaveform:{default:!0},enableVolume:{default:!0},fftSize:{default:2048},smoothingTimeConstant:{default:.8},src:{parse:function(t){return t.constructor!==String?t:t.startsWith("#")||t.startsWith(".")?document.querySelector(t):t}},unique:{default:!1}},init:function(){this.audioEl=null,this.levels=null,this.waveform=null,this.volume=0,this.xhr=null,this.initContext()},update:function(t){var e=this.analyser,n=this.data;t.fftSize===n.fftSize&&t.smoothingTimeConstant===n.smoothingTimeConstant||(e.fftSize=n.fftSize,e.smoothingTimeConstant=n.smoothingTimeConstant,this.levels=new Uint8Array(e.frequencyBinCount),this.waveform=new Uint8Array(e.fftSize)),n.src&&this.refreshSource()},tick:function(t,e){var n,i=this.data;if(i.enabled){if((i.enableLevels||i.enableVolume)&&this.analyser.getByteFrequencyData(this.levels),i.enableWaveform&&this.analyser.getByteTimeDomainData(this.waveform),i.enableVolume||i.enableBeatDetection){for(var o=0,r=0;r<this.levels.length;r++)o+=this.levels[r];this.volume=o/this.levels.length}i.enableBeatDetection&&(n=this.volume,this.beatCutOff||(this.beatCutOff=n),n>this.beatCutOff&&n>this.data.beatDetectionMinVolume?(this.el.emit("audioanalyserbeat",null,!1),this.beatCutOff=1.5*n,this.beatTime=0):this.beatTime<=this.data.beatDetectionThrottle?this.beatTime+=e:(this.beatCutOff*=this.data.beatDetectionDecay,this.beatCutOff=Math.max(this.beatCutOff,this.data.beatDetectionMinVolume)))}},initContext:function(){var t,e,n=this.data;this.context=new(window.webkitAudioContext||window.AudioContext),t=this.analyser=this.context.createAnalyser(),e=this.gainNode=this.context.createGain(),e.connect(t),t.connect(this.context.destination),t.fftSize=n.fftSize,t.smoothingTimeConstant=n.smoothingTimeConstant,this.levels=new Uint8Array(t.frequencyBinCount),this.waveform=new Uint8Array(t.fftSize)},refreshSource:function(){var t=this,e=(this.analyser,this.data);e.buffer&&e.src.constructor===String?this.getBufferSource().then(function(e){t.source=e,t.source.connect(t.gainNode)}):(this.source=this.getMediaSource(),this.source.connect(this.gainNode))},suspendContext:function(){this.context.suspend()},resumeContext:function(){this.context.resume()},fetchAudioBuffer:function(t){var e=this;return i[t]?i[t].constructor===Promise?i[t]:Promise.resolve(i[t]):(i[t]=new Promise(function(n){var o=e.xhr=new XMLHttpRequest;o.open("GET",t),o.responseType="arraybuffer",o.addEventListener("load",function(){function r(e){i[t]=e,n(e)}var a=e.context.decodeAudioData(o.response,r);a&&a.constructor===Promise&&a.then(r).catch(console.error)}),o.send()}),i[t])},getBufferSource:function(){var t=this,e=this.data;return this.fetchAudioBuffer(e.src).then(function(){var n;return n=t.context.createBufferSource(),n.buffer=i[e.src],t.el.emit("audioanalyserbuffersource",n,!1),n}).catch(console.error)},getMediaSource:function(){var t={};return function(){var e=this.data.src.constructor===String?this.data.src:this.data.src.src;if(t[e])return t[e];this.data.src.constructor===String?(this.audio=document.createElement("audio"),this.audio.crossOrigin="anonymous",this.audio.setAttribute("src",this.data.src)):this.audio=this.data.src;var n=this.context.createMediaElementSource(this.audio);return t[e]=n,n}}()})}])});